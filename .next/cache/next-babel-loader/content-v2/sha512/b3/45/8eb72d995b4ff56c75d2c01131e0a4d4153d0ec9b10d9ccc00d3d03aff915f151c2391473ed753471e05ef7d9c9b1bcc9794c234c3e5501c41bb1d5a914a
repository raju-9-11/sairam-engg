{"ast":null,"code":"import { jsxDEV as _jsxDEV } from \"react/jsx-dev-runtime\";\nvar _jsxFileName = \"/home/pacman/Desktop/nextjs/lib/auth.js\";\n\nfunction _objectWithoutProperties(source, excluded) { if (source == null) return {}; var target = _objectWithoutPropertiesLoose(source, excluded); var key, i; if (Object.getOwnPropertySymbols) { var sourceSymbolKeys = Object.getOwnPropertySymbols(source); for (i = 0; i < sourceSymbolKeys.length; i++) { key = sourceSymbolKeys[i]; if (excluded.indexOf(key) >= 0) continue; if (!Object.prototype.propertyIsEnumerable.call(source, key)) continue; target[key] = source[key]; } } return target; }\n\nfunction _objectWithoutPropertiesLoose(source, excluded) { if (source == null) return {}; var target = {}; var sourceKeys = Object.keys(source); var key, i; for (i = 0; i < sourceKeys.length; i++) { key = sourceKeys[i]; if (excluded.indexOf(key) >= 0) continue; target[key] = source[key]; } return target; }\n\nimport React, { useState, useEffect, useContext, createContext } from 'react';\nimport Router from 'next/router';\nimport firebase from './firebase';\nimport { createUser } from './db';\nimport { useSnackbar } from 'notistack';\nconst authContext = /*#__PURE__*/createContext();\nexport function AuthProvider({\n  children\n}) {\n  const auth = useFirebaseAuth();\n  return /*#__PURE__*/_jsxDEV(authContext.Provider, {\n    value: auth,\n    children: children\n  }, void 0, false, {\n    fileName: _jsxFileName,\n    lineNumber: 11,\n    columnNumber: 10\n  }, this);\n}\nexport const useAuth = () => {\n  return useContext(authContext);\n};\n\nfunction useFirebaseAuth() {\n  const {\n    0: user,\n    1: setUser\n  } = useState(null);\n  const {\n    0: loading,\n    1: setLoading\n  } = useState(true);\n  const {\n    enqueueSnackbar\n  } = useSnackbar();\n  const {\n    0: type,\n    1: setType\n  } = useState(null);\n  const firestore = firebase.firestore();\n\n  const handleUser = async rawUser => {\n    // console.log('handleUser called', new Date(), rawUser);\n    if (rawUser) {\n      const user = await formatUser(rawUser);\n\n      const {\n        token\n      } = user,\n            userWithoutToken = _objectWithoutProperties(user, [\"token\"]);\n\n      setUser(user);\n      createUser(user.uid, userWithoutToken);\n      firestore.collection('users').doc(user.uid).get().then(response => {\n        setType(response.data().type);\n      });\n      setLoading(false);\n      return user;\n    } else {\n      setUser(false);\n      setLoading(false);\n      return false;\n    }\n  };\n\n  const signupWithEmail = (email, password, firstName, type, lastName, cid, years, redirect) => {\n    setLoading(true);\n    return firebase.auth().createUserWithEmailAndPassword(email, password).then(response => {\n      firestore.collection('users').doc(response.user.uid).set({\n        first_name: firstName,\n        last_name: lastName,\n        type: type,\n        cid: cid,\n        years: years\n      });\n      handleUser(response.user);\n      enqueueSnackbar(\"Registration successful (Set password for your account using forgot password link in signin page)\", {\n        variant: 'success'\n      });\n\n      if (redirect) {\n        Router.push(redirect);\n      }\n    }).catch(err => {\n      enqueueSnackbar(err.message, {\n        variant: 'error'\n      });\n    });\n  };\n\n  const resetPassword = email => {\n    setLoading(true);\n    return firebase.auth().sendPasswordResetEmail(email).then(response => {\n      enqueueSnackbar('Email sucessfully sent to the registered mail', {\n        variant: 'success'\n      });\n    }).catch(err => {\n      enqueueSnackbar(err.message, {\n        variant: \"error\"\n      });\n    });\n  };\n\n  const signinWithEmail = (email, password, redirect) => {\n    setLoading(true);\n    return firebase.auth().signInWithEmailAndPassword(email, password).then(response => {\n      handleUser(response.user);\n      enqueueSnackbar(\"Welcome back\", {\n        variant: 'success'\n      });\n\n      if (redirect) {\n        Router.push(redirect);\n      }\n    }).catch(e => {\n      enqueueSnackbar(e.message, {\n        variant: 'error'\n      });\n    });\n  };\n\n  const signinWithGoogle = redirect => {\n    setLoading(true);\n    return firebase.auth().signInWithPopup(new firebase.auth.GoogleAuthProvider()).then(response => {\n      handleUser(response.user);\n\n      if (redirect) {\n        Router.push(redirect);\n      }\n    });\n  };\n\n  const signout = () => {\n    return firebase.auth().signOut().then(() => {\n      handleUser(false);\n\n      if (user.emailVerified) {\n        enqueueSnackbar(\"User successfully logged out\", {\n          variant: 'success'\n        });\n        Router.push('/signin');\n      }\n    }).catch(e => {\n      enqueueSnackbar(e.message, {\n        variant: 'error'\n      });\n    });\n  };\n\n  useEffect(() => {\n    const unsubscribe = firebase.auth().onIdTokenChanged(handleUser);\n    return () => unsubscribe();\n  }, []);\n\n  const getFreshToken = async () => {\n    console.log('getFreshToken called', new Date());\n    const currentUser = firebase.auth().currentUser;\n\n    if (currentUser) {\n      const token = await currentUser.getIdToken(false);\n      return `${token}`;\n    } else {\n      return '';\n    }\n  };\n\n  return {\n    user,\n    loading,\n    signinWithEmail,\n    signinWithGoogle,\n    signout,\n    resetPassword,\n    getFreshToken,\n    signupWithEmail\n  };\n}\n\nconst formatUser = async user => {\n  // const token = await user.getIdToken(/* forceRefresh */ true);\n  const decodedToken = await user.getIdTokenResult(\n  /*forceRefresh*/\n  true);\n  const {\n    token,\n    expirationTime\n  } = decodedToken; // console.log(token);\n\n  return {\n    uid: user.uid,\n    email: user.email,\n    name: user.displayName,\n    provider: user.providerData[0].providerId,\n    photoUrl: user.photoURL,\n    emailVerified: user.emailVerified,\n    token,\n    expirationTime // stripeRole: await getStripeRole(),\n\n  };\n};","map":{"version":3,"sources":["/home/pacman/Desktop/nextjs/lib/auth.js"],"names":["React","useState","useEffect","useContext","createContext","Router","firebase","createUser","useSnackbar","authContext","AuthProvider","children","auth","useFirebaseAuth","useAuth","user","setUser","loading","setLoading","enqueueSnackbar","type","setType","firestore","handleUser","rawUser","formatUser","token","userWithoutToken","uid","collection","doc","get","then","response","data","signupWithEmail","email","password","firstName","lastName","cid","years","redirect","createUserWithEmailAndPassword","set","first_name","last_name","variant","push","catch","err","message","resetPassword","sendPasswordResetEmail","signinWithEmail","signInWithEmailAndPassword","e","signinWithGoogle","signInWithPopup","GoogleAuthProvider","signout","signOut","emailVerified","unsubscribe","onIdTokenChanged","getFreshToken","console","log","Date","currentUser","getIdToken","decodedToken","getIdTokenResult","expirationTime","name","displayName","provider","providerData","providerId","photoUrl","photoURL"],"mappings":"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","sourcesContent":["import React, { useState, useEffect, useContext, createContext } from 'react';\nimport Router from 'next/router';\nimport firebase from './firebase';\nimport { createUser } from './db';\nimport { useSnackbar } from 'notistack';\n\nconst authContext = createContext();\n\nexport function AuthProvider({ children }) {\n  const auth = useFirebaseAuth();\n  return <authContext.Provider value={auth}>{children}</authContext.Provider>;\n}\n\nexport const useAuth = () => {\n  return useContext(authContext);\n};\n\nfunction useFirebaseAuth() {\n  const [user, setUser] = useState(null);\n  const [loading, setLoading] = useState(true);\n  const { enqueueSnackbar } = useSnackbar();\n  const [ type, setType ] = useState(null);\n\n  const firestore = firebase.firestore();\n\n  const handleUser = async (rawUser) => {\n    // console.log('handleUser called', new Date(), rawUser);\n    if (rawUser) {\n      const user = await formatUser(rawUser);\n      const { token, ...userWithoutToken } = user;\n\n      setUser(user);\n      createUser(user.uid, userWithoutToken);\n      firestore\n        .collection('users')\n        .doc(user.uid)\n        .get()\n        .then((response) => {\n          setType(response.data().type)\n        })\n\n      setLoading(false);\n      return user;\n    } else {\n      setUser(false);\n      setLoading(false);\n      return false;\n    }\n  };\n\n  const signupWithEmail = (email, password, firstName, type, lastName, cid, years, redirect) => {\n    setLoading(true);\n    return firebase\n      .auth()\n      .createUserWithEmailAndPassword(email, password)\n      .then((response) => {\n        firestore.collection('users').doc(response.user.uid)\n        .set({\n          first_name: firstName,\n          last_name: lastName,\n          type: type,\n          cid: cid,\n          years: years\n        })\n        handleUser(response.user);\n        enqueueSnackbar(\"Registration successful (Set password for your account using forgot password link in signin page)\", { variant: 'success'})\n    \n        if (redirect) {\n          Router.push(redirect);\n        }\n    })\n    .catch((err) => {\n      enqueueSnackbar(err.message, {variant  :'error'})\n    });\n    \n  }\n\n  const resetPassword = ( email ) => {\n    setLoading(true)\n    return firebase\n      .auth()\n      .sendPasswordResetEmail(email)\n      .then((response) => {\n        enqueueSnackbar('Email sucessfully sent to the registered mail',{variant: 'success'});\n      })\n      .catch((err) => {\n        enqueueSnackbar(err.message,{variant:\"error\"})\n      })\n  }\n\n\n  const signinWithEmail = (email, password, redirect) => {\n    setLoading(true);\n    return firebase\n      .auth()\n      .signInWithEmailAndPassword(email, password)\n      .then((response) => {\n        handleUser(response.user);\n\n        enqueueSnackbar(\"Welcome back\", { variant: 'success'})\n        if (redirect) {\n          Router.push(redirect);\n        }\n      })\n      .catch((e)=>{\n        enqueueSnackbar(e.message, {variant  :'error'})\n      });\n  };\n\n\n  const signinWithGoogle = (redirect) => {\n    setLoading(true);\n    return firebase\n      .auth()\n      .signInWithPopup(new firebase.auth.GoogleAuthProvider())\n      .then((response) => {\n        handleUser(response.user);\n\n        if (redirect) {\n          Router.push(redirect);\n        }\n      });\n  };\n\n  const signout = () => {\n    return firebase\n      .auth()\n      .signOut()\n      .then(() => {\n        handleUser(false)\n        if(user.emailVerified){\n          enqueueSnackbar(\"User successfully logged out\", { variant: 'success'});\n          Router.push('/signin')\n        }\n      })\n      .catch((e)=>{\n        enqueueSnackbar(e.message, {variant  :'error'})\n      });\n  };\n\n  useEffect(() => {\n    const unsubscribe = firebase.auth().onIdTokenChanged(handleUser);\n    return () => unsubscribe();\n  }, []);\n\n\n  const getFreshToken = async () => {\n    console.log('getFreshToken called', new Date());\n    const currentUser = firebase.auth().currentUser;\n    if (currentUser) {\n      const token = await currentUser.getIdToken(false);\n      return `${token}`;\n    } else {\n      return '';\n    }\n  };\n\n  return {\n    user,\n    loading,\n    signinWithEmail,\n    signinWithGoogle,\n    signout,\n    resetPassword,\n    getFreshToken,\n    signupWithEmail\n  };\n}\n\n\nconst formatUser = async (user) => {\n  // const token = await user.getIdToken(/* forceRefresh */ true);\n  const decodedToken = await user.getIdTokenResult(/*forceRefresh*/ true);\n  const { token, expirationTime } = decodedToken;\n  // console.log(token);\n  return {\n    uid: user.uid,\n    email: user.email,\n    name: user.displayName,\n    provider: user.providerData[0].providerId,\n    photoUrl: user.photoURL,\n    emailVerified: user.emailVerified,\n    token,\n    expirationTime,\n    // stripeRole: await getStripeRole(),\n  };\n};"]},"metadata":{},"sourceType":"module"}