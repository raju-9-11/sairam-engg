{"ast":null,"code":"import { jsxDEV as _jsxDEV } from \"react/jsx-dev-runtime\";\nvar _jsxFileName = \"/home/pacman/Desktop/nextjs/lib/auth.js\";\n\nfunction _objectWithoutProperties(source, excluded) { if (source == null) return {}; var target = _objectWithoutPropertiesLoose(source, excluded); var key, i; if (Object.getOwnPropertySymbols) { var sourceSymbolKeys = Object.getOwnPropertySymbols(source); for (i = 0; i < sourceSymbolKeys.length; i++) { key = sourceSymbolKeys[i]; if (excluded.indexOf(key) >= 0) continue; if (!Object.prototype.propertyIsEnumerable.call(source, key)) continue; target[key] = source[key]; } } return target; }\n\nfunction _objectWithoutPropertiesLoose(source, excluded) { if (source == null) return {}; var target = {}; var sourceKeys = Object.keys(source); var key, i; for (i = 0; i < sourceKeys.length; i++) { key = sourceKeys[i]; if (excluded.indexOf(key) >= 0) continue; target[key] = source[key]; } return target; }\n\nimport React, { useState, useEffect, useContext, createContext } from 'react';\nimport Router from 'next/router';\nimport firebase from './firebase';\nimport { createUser } from './db';\nconst authContext = /*#__PURE__*/createContext();\nexport function AuthProvider({\n  children\n}) {\n  const auth = useFirebaseAuth();\n  return /*#__PURE__*/_jsxDEV(authContext.Provider, {\n    value: auth,\n    children: children\n  }, void 0, false, {\n    fileName: _jsxFileName,\n    lineNumber: 10,\n    columnNumber: 10\n  }, this);\n}\nexport const useAuth = () => {\n  return useContext(authContext);\n};\n\nfunction useFirebaseAuth() {\n  const {\n    0: user,\n    1: setUser\n  } = useState(null);\n  const {\n    0: loading,\n    1: setLoading\n  } = useState(true);\n\n  const handleUser = async rawUser => {\n    console.log('handleUser called', new Date());\n\n    if (rawUser) {\n      const user = await formatUser(rawUser);\n\n      const {\n        token\n      } = user,\n            userWithoutToken = _objectWithoutProperties(user, [\"token\"]);\n\n      createUser(user.uid, userWithoutToken);\n      setUser(user);\n      setLoading(false);\n      return user;\n    } else {\n      setUser(false);\n      setLoading(false);\n      return false;\n    }\n  };\n\n  const signinWithEmail = (email, password, redirect) => {\n    setLoading(true);\n    return firebase.auth().signInWithEmailAndPassword(email, password).then(response => {\n      handleUser(response.user);\n\n      if (redirect) {\n        Router.push(redirect);\n      }\n    });\n  };\n\n  const signinWithGitHub = redirect => {\n    setLoading(true);\n    return firebase.auth().signInWithPopup(new firebase.auth.GithubAuthProvider()).then(response => {\n      handleUser(response.user);\n\n      if (redirect) {\n        Router.push(redirect);\n      }\n    });\n  };\n\n  const signinWithTwitter = redirect => {\n    setLoading(true);\n    return firebase.auth().signInWithPopup(new firebase.auth.TwitterAuthProvider()).then(response => {\n      handleUser(response.user);\n\n      if (redirect) {\n        Router.push(redirect);\n      }\n    });\n  };\n\n  const signinWithGoogle = redirect => {\n    setLoading(true);\n    return firebase.auth().signInWithPopup(new firebase.auth.GoogleAuthProvider()).then(response => {\n      handleUser(response.user);\n\n      if (redirect) {\n        Router.push(redirect);\n      }\n    });\n  };\n\n  const signout = () => {\n    return firebase.auth().signOut().then(() => handleUser(false));\n  };\n\n  useEffect(() => {\n    const unsubscribe = firebase.auth().onIdTokenChanged(handleUser);\n    return () => unsubscribe();\n  }, []); // useEffect(() => {\n  //   const interval = setInterval(async () => {\n  //     if (user) {\n  //       const token = await firebase\n  //         .auth()\n  //         .currentUser.getIdToken(/* forceRefresh */ true);\n  //       setUser(user);\n  //       console.log('refreshed token');\n  //     }\n  //   }, 30 * 60 * 1000 /*every 30min, assuming token expires every 1hr*/);\n  //   return () => clearInterval(interval);\n  // }, [user]); // needs to depend on user to have closure on a valid user object in callback fun\n\n  const getFreshToken = async () => {\n    console.log('getFreshToken called', new Date());\n    const currentUser = firebase.auth().currentUser;\n\n    if (currentUser) {\n      const token = await currentUser.getIdToken(false);\n      return `${token}`;\n    } else {\n      return '';\n    }\n  };\n\n  return {\n    user,\n    loading,\n    signinWithEmail,\n    signinWithGitHub,\n    signinWithTwitter,\n    signinWithGoogle,\n    signout,\n    getFreshToken\n  };\n} // const getStripeRole = async () => {\n//   await firebase.auth().currentUser.getIdToken(true);\n//   const decodedToken = await firebase.auth().currentUser.getIdTokenResult();\n//   return decodedToken.claims.stripeRole || 'free';\n// };\n\n\nconst formatUser = async user => {\n  // const token = await user.getIdToken(/* forceRefresh */ true);\n  const decodedToken = await user.getIdTokenResult(\n  /*forceRefresh*/\n  true);\n  const {\n    token,\n    expirationTime\n  } = decodedToken;\n  console.log(token);\n  return {\n    uid: user.uid,\n    email: user.email,\n    name: user.displayName,\n    provider: user.providerData[0].providerId,\n    photoUrl: user.photoURL,\n    token,\n    expirationTime // stripeRole: await getStripeRole(),\n\n  };\n};","map":{"version":3,"sources":["/home/pacman/Desktop/nextjs/lib/auth.js"],"names":["React","useState","useEffect","useContext","createContext","Router","firebase","createUser","authContext","AuthProvider","children","auth","useFirebaseAuth","useAuth","user","setUser","loading","setLoading","handleUser","rawUser","console","log","Date","formatUser","token","userWithoutToken","uid","signinWithEmail","email","password","redirect","signInWithEmailAndPassword","then","response","push","signinWithGitHub","signInWithPopup","GithubAuthProvider","signinWithTwitter","TwitterAuthProvider","signinWithGoogle","GoogleAuthProvider","signout","signOut","unsubscribe","onIdTokenChanged","getFreshToken","currentUser","getIdToken","decodedToken","getIdTokenResult","expirationTime","name","displayName","provider","providerData","providerId","photoUrl","photoURL"],"mappings":"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","sourcesContent":["import React, { useState, useEffect, useContext, createContext } from 'react';\nimport Router from 'next/router';\nimport firebase from './firebase';\nimport { createUser } from './db';\n\nconst authContext = createContext();\n\nexport function AuthProvider({ children }) {\n  const auth = useFirebaseAuth();\n  return <authContext.Provider value={auth}>{children}</authContext.Provider>;\n}\n\nexport const useAuth = () => {\n  return useContext(authContext);\n};\n\nfunction useFirebaseAuth() {\n  const [user, setUser] = useState(null);\n  const [loading, setLoading] = useState(true);\n\n  const handleUser = async (rawUser) => {\n    console.log('handleUser called', new Date());\n    if (rawUser) {\n      const user = await formatUser(rawUser);\n      const { token, ...userWithoutToken } = user;\n\n      createUser(user.uid, userWithoutToken);\n      setUser(user);\n\n      setLoading(false);\n      return user;\n    } else {\n      setUser(false);\n      setLoading(false);\n      return false;\n    }\n  };\n\n  const signinWithEmail = (email, password, redirect) => {\n    setLoading(true);\n    return firebase\n      .auth()\n      .signInWithEmailAndPassword(email, password)\n      .then((response) => {\n        handleUser(response.user);\n\n        if (redirect) {\n          Router.push(redirect);\n        }\n      });\n  };\n\n  const signinWithGitHub = (redirect) => {\n    setLoading(true);\n    return firebase\n      .auth()\n      .signInWithPopup(new firebase.auth.GithubAuthProvider())\n      .then((response) => {\n        handleUser(response.user);\n\n        if (redirect) {\n          Router.push(redirect);\n        }\n      });\n  };\n\n  const signinWithTwitter = (redirect) => {\n    setLoading(true);\n    return firebase\n      .auth()\n      .signInWithPopup(new firebase.auth.TwitterAuthProvider())\n      .then((response) => {\n        handleUser(response.user);\n\n        if (redirect) {\n          Router.push(redirect);\n        }\n      });\n  };\n\n  const signinWithGoogle = (redirect) => {\n    setLoading(true);\n    return firebase\n      .auth()\n      .signInWithPopup(new firebase.auth.GoogleAuthProvider())\n      .then((response) => {\n        handleUser(response.user);\n\n        if (redirect) {\n          Router.push(redirect);\n        }\n      });\n  };\n\n  const signout = () => {\n    return firebase\n      .auth()\n      .signOut()\n      .then(() => handleUser(false));\n  };\n\n  useEffect(() => {\n    const unsubscribe = firebase.auth().onIdTokenChanged(handleUser);\n    return () => unsubscribe();\n  }, []);\n\n  // useEffect(() => {\n  //   const interval = setInterval(async () => {\n  //     if (user) {\n  //       const token = await firebase\n  //         .auth()\n  //         .currentUser.getIdToken(/* forceRefresh */ true);\n  //       setUser(user);\n  //       console.log('refreshed token');\n  //     }\n  //   }, 30 * 60 * 1000 /*every 30min, assuming token expires every 1hr*/);\n  //   return () => clearInterval(interval);\n  // }, [user]); // needs to depend on user to have closure on a valid user object in callback fun\n\n  const getFreshToken = async () => {\n    console.log('getFreshToken called', new Date());\n    const currentUser = firebase.auth().currentUser;\n    if (currentUser) {\n      const token = await currentUser.getIdToken(false);\n      return `${token}`;\n    } else {\n      return '';\n    }\n  };\n\n  return {\n    user,\n    loading,\n    signinWithEmail,\n    signinWithGitHub,\n    signinWithTwitter,\n    signinWithGoogle,\n    signout,\n    getFreshToken,\n  };\n}\n\n// const getStripeRole = async () => {\n//   await firebase.auth().currentUser.getIdToken(true);\n//   const decodedToken = await firebase.auth().currentUser.getIdTokenResult();\n//   return decodedToken.claims.stripeRole || 'free';\n// };\n\nconst formatUser = async (user) => {\n  // const token = await user.getIdToken(/* forceRefresh */ true);\n  const decodedToken = await user.getIdTokenResult(/*forceRefresh*/ true);\n  const { token, expirationTime } = decodedToken;\n  console.log(token);\n  return {\n    uid: user.uid,\n    email: user.email,\n    name: user.displayName,\n    provider: user.providerData[0].providerId,\n    photoUrl: user.photoURL,\n    token,\n    expirationTime,\n    // stripeRole: await getStripeRole(),\n  };\n};"]},"metadata":{},"sourceType":"module"}